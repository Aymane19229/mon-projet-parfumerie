"""
Modèle de données pour représenter une vulnérabilité normalisée

Pourquoi : Standardiser tous les rapports de vulnérabilités en un format unique
Comment : Chaque parser (SAST, SCA, DAST) convertit ses rapports en ce format
"""
from dataclasses import dataclass
from typing import Optional, List
from enum import Enum


class Severity(Enum):
    """Niveaux de sévérité normalisés"""
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"
    INFO = "INFO"


class VulnerabilityType(Enum):
    """Types de vulnérabilités"""
    SAST = "SAST"  # Static Analysis Security Testing
    SCA = "SCA"    # Software Composition Analysis
    DAST = "DAST"  # Dynamic Application Security Testing


@dataclass
class Vulnerability:
    """
    Modèle de données pour une vulnérabilité normalisée
    
    Pourquoi : Unifier tous les formats de rapports (JSON, XML) en un seul modèle
    Comment : Chaque parser convertit ses résultats en objets Vulnerability
    """
    # Identifiants
    id: str  # ID unique de la vulnérabilité (CVE, Bug ID, etc.)
    title: str  # Titre/nom de la vulnérabilité
    
    # Classification
    severity: Severity  # Niveau de criticité
    vulnerability_type: VulnerabilityType  # SAST, SCA, ou DAST
    category: str  # Catégorie (SQL Injection, XSS, CVE, etc.)
    
    # Description
    description: str  # Description détaillée
    recommendation: Optional[str] = None  # Recommandation pour corriger
    
    # Localisation
    file_path: Optional[str] = None  # Fichier où se trouve la vulnérabilité
    line_number: Optional[int] = None  # Numéro de ligne
    function_name: Optional[str] = None  # Fonction/méthode concernée
    
    # Contexte
    tool_name: str  # Nom de l'outil qui a détecté (SpotBugs, ESLint, ZAP, etc.)
    raw_data: Optional[dict] = None  # Données brutes pour référence
    
    # Pour SCA uniquement
    dependency_name: Optional[str] = None  # Nom de la dépendance vulnérable
    dependency_version: Optional[str] = None  # Version vulnérable
    fixed_version: Optional[str] = None  # Version corrigée
    
    # Pour DAST uniquement
    endpoint: Optional[str] = None  # Endpoint/URL concerné
    http_method: Optional[str] = None  # Méthode HTTP (GET, POST, etc.)
    
    def to_dict(self) -> dict:
        """Convertir en dictionnaire pour JSON/LLM"""
        return {
            "id": self.id,
            "title": self.title,
            "severity": self.severity.value,
            "type": self.vulnerability_type.value,
            "category": self.category,
            "description": self.description,
            "recommendation": self.recommendation,
            "file_path": self.file_path,
            "line_number": self.line_number,
            "function_name": self.function_name,
            "tool_name": self.tool_name,
            "dependency_name": self.dependency_name,
            "dependency_version": self.dependency_version,
            "fixed_version": self.fixed_version,
            "endpoint": self.endpoint,
            "http_method": self.http_method
        }

